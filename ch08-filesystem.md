# 第8章 ファイルシステム

- アプリケーションにとっては、ディスク、ストレージデバイスのパフォーマンスよりもファイルシステムのパフォーマンスの方が重要な意味がある。
  - アプリケーションがやり取りし、処理終了を待つのはファイルシステムだから。
  - ファイルシステムは、アプリケーションがディスク（またはリモートストレージデバイス）レベルのレイテンシに支配されないように、キャッシング、バッファリング、非同期I/Oを駆使することができる。
- しかし、システムパフォーマンスの分析、モニタリングツールは、伝統的にファイルシステムパフォーマンスは盲点になっていた。
## 8.1 用語

- ファイルシステム（file system）: データをファイルとディレクトリに組織したもので、データアクセスのためのファイルベースインターフェイスとアクセス制御のためのファイルパーミッションを備えている。
- ファイルシステムキャッシュ（file system cache）:　ファイルシステム内のコンテンツをキャッシングするために使われるメインメモリ（通常DRAM）内の領域。
- オペレーション（operation、操作）: read(2)、write(2)、open(2)、close(2)、stat(2)、mkdir(2) など
- I/O（input/output、入出力）: 本書では、直接読み書きする（I/O を実行する）オペレーションだけをI/O と呼ぶ。（open(2) とclose(2) は、I/O には含まれない）
- 論理I/O（logical I/O）: アプリケーションがファイルシステムに対して発行するI/O要求のこと。
- 物理I/O（physical I/O）: ファイルシステムがディスクに直接発行する（またはRaw I/O による）I/O要求のこと。
- ブロックサイズ（レコードサイズ（record size））: ディスク上のファイルシステムデータグループのサイズ。
- スループット（throughput）: アプリケーションとファイルシステムの間でのデータ転送速度。
- i ノード（inode）: インデックスノード（index node）という意味。メタデータを格納するデータ構造。
- VFS（Virtual File System）: 異なるファイルシステムタイプを抽象化してサポートするためのカーネルインターフェイス。
- （仮想）ボリューム（volume）: ストレージのインスタンスのこと
- ボリュームマネージャ（volume manager）: 物理ストレージデバイスを柔軟に管理するためのソフトウェア


## 8.2 モデル

### 8.2.1 ファイルシステムインターフェイス
### 8.2.2 ファイルシステムキャッシュ
### 8.2.3 2次キャッシュ

## 8.3 コンセプト
### 8.3.1 ファイルシステムレイテンシ
### 8.3.2 キャッシング
### 8.3.3 ランダムI/OとシーケンシャルI/O
### 8.3.4 プリフェッチ
### 8.3.5 先読み

### 8.3.6 ライトバックキャッシング
### 8.3.7 同期書き込み
### 8.3.8 Raw I/OとDirect I/O
### 8.3.9 ノンブロッキングI/O
### 8.3.10 メモリマップトファイル
### 8.3.11 メタデータ
### 8.3.12 論理I/Oと物理I/O
### 8.3.13 オペレーションは平等ではない
### 8.3.14 特殊ファイルシステム
### 8.3.15 最終アクセス時刻
### 8.3.16 容量

## 8.4 アーキテクチャ
### 8.4.1 ファイルシステムI/Oスタック
### 8.4.2 VFS
### 8.4.3 ファイルシステムキャッシュ
### 8.4.4 ファイルシステムのパフォーマンスに関わるその他の機能と属性
#### 8.4.4.1 ブロックとエクステント
#### 8.4.4.2 ジャーナリング
#### 8.4.4.3 コピーオンライト
#### 8.4.4.4 スクラビング
#### 8.4.4.5 その他の機能

### 8.4.5 ファイルシステムタイプ
#### 8.4.5.1 FFS
#### 8.4.5.2 ext3
#### 8.4.5.3 ext4
#### 8.4.5.4 XFS
#### 8.4.5.5 ZFS
#### 8.4.5.6 Btrfs

### 8.4.6 ボリュームとプール

## 8.5 メソドロジ

### 8.5.1 ディスク分析
### 8.5.2 レイテンシ分析
#### 8.5.2.1 トランザクションのコスト
### 8.5.3 ワークロードの特性の把握
#### 8.5.3.1 高度なワークロードの特性チェックリスト
#### 8.5.3.2 パフォーマンスの特性の把握
#### 8.5.3.3 イベントトレーシング
### 8.5.4 パフォーマンスモニタリング
### 8.5.5 静的パフォーマンスチューニング
### 8.5.6 キャッシュのチューニング
### 8.5.7 ワークロードの分離
### 8.5.8 マイクロベンチマーキング

## 8.6 可観測性ツール

### 8.6.1 mount
### 8.6.2 free
### 8.6.3 top
### 8.6.4 vmstat
### 8.6.5 sar
### 8.6.6 slabtop
### 8.6.7 strace
### 8.6.8 fatrace
### 8.6.9 LatencyTOP
### 8.6.10 opensnoop
### 8.6.11 filetop
### 8.6.12 cachestat
### 8.6.13 ext4dist（xfs、zfs、btrfs、nfs）
### 8.6.14 ext4slower（xfs、zfs、btrfs、nfs）
### 8.6.15 bpftrace
#### 8.6.15.1 1行プログラム
#### 8.6.15.2 システムコールのトレース
#### 8.6.15.3 VFSのトレーシング
#### 8.6.15.4 ファイルシステムの内部構造
### 8.6.16 その他のツール
#### 8.6.16.1 ZFS
### 8.6.17 ビジュアライゼーション

## 8.7 実験

### 8.7.1 アドホックテスト
### 8.7.2 マイクロベンチマークツール
#### 8.7.2.1 Bonnie、Bonnie++
#### 8.7.2.2 fio
#### 8.7.2.3 FileBench
### 8.7.3 キャッシュのフラッシュ

## 8.8 チューニング

### 8.8.1 アプリケーションからの呼び出し
#### 8.8.1.1 posix_fadvise( )
#### 8.8.1.2 madvise( )
### 8.8.2 ext4
#### 8.8.2.1 mountとtnue2fs
#### 8.8.2.2 /sys/fsプロパティファイル
#### 8.8.2.3 e2fsck
### 8.8.3 ZFS

## 8.9 練習問題

1. ファイルシステムの用語についての以下の問いに答えなさい。
- 論理I/Oと物理I/Oの違いは何か。
- ランダムI/OとシーケンシャルI/Oの違いは何か。
- DirectI/O とは何か。
- ノンブロッキングI/Oとは何か。
- ワーキングセットサイズとは何か。

2. コンセプトについての以下の問いに答えなさい。
- VFSの役割は何か。
- ファイルシステムレイテンシについて、特にどこでそれを計測できるかについて説明しなさい。
- プリフェッチ（先読み）の目的は何か。
- Direct I/Oの目的は何か。

3. 以下の少し難しい問いに答えなさい。
- O_SYNC ではなくfsync(2) を使うメリットを説明しなさい。
- read(2)/write(2) との比較でmmap(2)の利点、欠点を説明しなさい。
- 論理I/Oが物理I/Oになるとサイズが大きくなるのはどういうときかを説明しなさい。
- 論理I/Oが物理I/Oになるとサイズが小さくなるのはどういうときかを説明しなさい。
- ファイルシステムのCOW（コピーオンライト）がパフォーマンスを向上させる仕組みを説明しなさい。

4. あなたの環境のために次のものを作りなさい。
- ファイルシステムキャッシュをチューニングするためのチェックリスト。存在するファイルシステムキャッシュをリストアップし、現在のサイズ、使用状況、ヒット率をチェックする方法をまとめること。
- ファイルシステムを操作するワークロードの特性の把握チェックリスト。個々の詳細情報の取得方法を入れること。まずOSが提供する既存の可観測性ツールを使うようにしなさい。

5. 以下の作業をしなさい。
- アプリケーションを選び、ファイルシステムオペレーションとレイテンシを計測しなさい。次の条件を満たすこと。
  - ファイルシステムオペレーションのレイテンシの平均だけでなく、完全な分布を示すこと。
  - 個々のアプリケーションスレッドがファイルシステムオペレーションのために費やす時間の秒未満の部分を明らかにすること。
- マイクロベンチマークツールを使って、ファイルシステムキャッシュのサイズを実験的に調べなさい。使ったツールを選んだ理由を説明すること。また、ワーキングセットがキャッシングできなくなったときのパフォーマンスの劣化を示しなさい（何らかの指標を使って）。


6. （オプション、高度）ファイルシステムに対する同期書き込みと非同期書き込みを計測する可観測性ツールを開発しなさい。頻度とレイテンシを表示し、発行したプロセスID を突き止められるようにすること。また、ワークロードの特性の把握に適したものにすること。

7. （オプション、高度）間接的で大きくされたファイルシステムI/O、つまりアプリケーションが直接発行していないのに追加されたバイトとI/Oの統計を表示するツールを開発しなさい。ツールは、追加されたI/Oをタイプ別に分類し、理由を説明できなければならない。

## 8.10 参考文献
